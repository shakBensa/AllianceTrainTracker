<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SHOO Alliance Train Riders</title>
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
      font-size: 16px;
    }
    .alliance-logo {
      margin: 0 auto 15px;
      max-width: 600px;
      position: relative;
    }
    .alliance-name {
      font-family: 'Anton', sans-serif;
      color: #ffcc00;
      text-shadow: 2px 2px 6px #000;
      font-size: 2.2rem;
      letter-spacing: 4px;
      margin-bottom: 0;
    }
    .alliance-tagline {
      color: #aaa;
      font-style: italic;
      margin-top: 0;
      font-size: 0.9rem;
      letter-spacing: 1px;
    }
    h1 {
      font-family: 'Anton', sans-serif;
      color: #ffcc00;
      text-shadow: 2px 2px 6px #000;
      font-size: 1.8rem;
      margin-top: 0;
    }
    #dateDisplay, #countdown {
      font-size: 1rem;
      color: #aaa;
      margin-bottom: 10px;
    }
    button {
      margin: 10px 5px;
      padding: 10px 15px;
      background-color: #ffcc00;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
    }
    button:disabled {
      background-color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .admin-button {
      background-color: #ff9900;
    }
    .train { 
      display: flex; 
      justify-content: center; 
      flex-wrap: wrap; 
      margin-top: 20px; 
    }
    .wagon {
      background: #2b2b2b;
      border: 4px solid #333;
      border-radius: 0 0 10px 10px;
      margin: 10px;
      width: calc(100% - 50px);
      max-width: 240px;
      padding: 20px 15px 30px;
      box-shadow: inset 0 2px 0 #666, 0 8px 10px rgba(0, 0, 0, 0.5);
      position: relative;
      animation: depart 1.5s ease-in-out;
    }
    @keyframes depart {
      0% { transform: translateX(-50px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    .wagon::before {
      content: "üöÉ";
      font-size: 40px;
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
    }
    .wagon h2 { 
      margin-top: 0; 
      color: #00e676; 
      font-size: 1.2rem; 
      position: relative;
    }
    /* .wagon h2:after {
      content: "SHOO";
      position: absolute;
      right: 0;
      top: 0;
      font-size: 0.65rem;
      color: #ffcc00;
      opacity: 0.6;
      letter-spacing: 1px;
    } */
    .wagon ul { list-style: none; padding: 0; margin: 0; }
    .wagon li { margin: 8px 0; font-size: 0.95rem; word-break: break-word; }
    .r4r5 { color: gold; font-weight: bold; }
    .leader { color: #cc44ff; font-weight: bold; }
    #historyLog {
      display: none;
      text-align: left;
      background: #1c1c1c;
      padding: 10px;
      margin-top: 30px;
      border: 1px solid #444;
      border-radius: 8px;
      width: calc(100% - 20px);
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      overflow-x: auto;
    }
    #memberPanel {
      display: none;
      text-align: left;
      background: #1c1c1c;
      padding: 15px;
      margin-top: 30px;
      border: 1px solid #444;
      border-radius: 8px;
      width: calc(100% - 30px);
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      overflow-x: auto;
    }
    #historyLog h3, #memberPanel h3 { 
      color: #ffcc00; 
      position: relative;
    }
    #historyLog h3:after, #memberPanel h3:after {
      content: "SHOO";
      position: absolute;
      right: 10px;
      top: 0;
      font-size: 1rem;
      color: #ffcc00;
      opacity: 0.6;
      letter-spacing: 1px;
    }
    #historyTools, #memberTools {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
    }
    select, input[type="text"], input[type="password"] {
      margin: 10px 5px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      max-width: 100%;
      box-sizing: border-box;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      max-width: 300px;
    }
    .stats {
      background: #1c1c1c;
      border-radius: 8px;
      padding: 10px;
      margin: 20px auto;
      max-width: 100%;
      text-align: left;
      overflow-x: auto;
    }
    .stats h3 { color: #ffcc00; margin-top: 0; }
    .fairness-indicator {
      font-size: 10px;
      vertical-align: super;
      margin-left: 3px;
      color: #66ff66;
    }
    #historyContent {
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.9rem;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .pagination button {
      margin: 5px;
      padding: 5px 10px;
    }
    .pagination-info {
      margin: 0 10px;
      color: #aaa;
      font-size: 0.85rem;
    }
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-top: 15px;
    }
    .page-size-control {
      display: flex;
      align-items: center;
      font-size: 0.85rem;
      color: #aaa;
    }
    .page-size-control select {
      margin-left: 8px;
    }
    .member-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    .member-item {
      background: #2b2b2b;
      border: 2px solid #444;
      border-radius: 5px;
      padding: 8px 12px;
      position: relative;
      display: flex;
      align-items: center;
    }
    .member-item.r4r5 {
      border-color: gold;
    }
    .member-item.leader {
      border-color: #cc44ff;
    }
    .member-delete {
      cursor: pointer;
      margin-left: 8px;
      color: #ff6666;
      font-weight: bold;
    }
    .member-role-toggle {
      cursor: pointer;
      margin-left: 8px;
      display: inline-block;
    }
    .role-r4r5 {
      color: #ffcc00;
    }
    .role-leader {
      color: #cc44ff;
    }
    .add-member-form {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }
    .add-member-form input[type="text"] {
      flex-grow: 1;
      max-width: 250px;
    }
    .role-options {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .role-option {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #aaa;
    }
    .role-tag {
      margin-right: 5px;
      font-weight: bold;
    }
    .r4r5-tag {
      color: gold;
    }
    .leader-tag {
      color: #cc44ff;
    }
    .import-export-area {
      margin-top: 25px;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin: 10px 0;
      background: #222;
      color: #ddd;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      resize: vertical;
      font-family: monospace;
    }
    .reset-notice {
      color: #ff6666;
      font-size: 0.85rem;
      margin-top: 5px;
    }
    
    /* Password dialog */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      border: 2px solid #444;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      text-align: center;
    }
    .modal-title {
      color: #ffcc00;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }
    .modal-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .modal-form p {
      text-align: center;
      margin-bottom: 15px;
    }
    .modal-form input[type="password"] {
      width: 80%;
      margin: 10px auto;
      text-align: center;
    }
    .modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .hidden {
      display: none;
    }
    
    /* Settings panel */
    .settings-section {
      margin: 15px 0;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 5px;
    }
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .settings-label {
      flex-grow: 1;
      text-align: left;
      margin-right: 10px;
    }
    
    .footer {
      margin-top: 40px;
      font-size: 0.8rem;
      color: #666;
      text-align: center;
    }
    .footer .alliance-name {
      font-size: 1rem;
      display: inline-block;
      vertical-align: middle;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 600px) {
      body {
        padding: 10px;
        font-size: 14px;
      }
      .alliance-name {
        font-size: 1.8rem;
      }
      .alliance-tagline {
        font-size: 0.8rem;
      }
      h1 {
        font-size: 1.5rem;
        margin-top: 10px;
      }
      button {
        padding: 8px 12px;
        margin: 5px 3px;
        font-size: 0.85rem;
        white-space: nowrap;
      }
      .wagon {
        margin: 8px 4px;
        padding: 15px 10px 25px;
      }
      .wagon::before {
        font-size: 30px;
        top: -15px;
      }
      .wagon h2 {
        font-size: 1rem;
      }
      .wagon li {
        font-size: 0.85rem;
        margin: 6px 0;
      }
      #historyTools, #memberTools {
        flex-direction: column;
        align-items: stretch;
      }
      select, input[type="text"], input[type="password"] {
        width: 100%;
        margin: 5px 0;
      }
      #statsContent table {
        font-size: 0.8rem;
      }
      #statsContent th, #statsContent td {
        padding: 3px !important;
      }
      #dateDisplay, #countdown {
        font-size: 0.85rem;
      }
      .pagination {
        flex-direction: column;
      }
      .pagination-controls {
        flex-direction: column;
      }
      .page-size-control {
        margin-top: 10px;
      }
      .add-member-form {
        flex-direction: column;
        align-items: stretch;
      }
      .add-member-form input, .add-member-form button {
        width: 100%;
        max-width: 100%;
        margin: 5px 0;
      }
      .role-options {
        flex-direction: column;
        align-items: flex-start;
      }
      .settings-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .settings-row input, .settings-row button {
        width: 100%;
        margin-top: 5px;
      }
    }
    
    /* Table responsiveness for stats */
    .stats table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats td, .stats th {
      padding: 5px;
      border-bottom: 1px solid #333;
    }
    @media (max-width: 480px) {
      .stats table {
        font-size: 0.75rem;
      }
      .stats td, .stats th {
        padding: 2px;
      }
    }

    /* Buttons at top */
    .top-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <!-- <div class="alliance-logo">
    <h2 class="alliance-name">SHOO</h2>
    <p class="alliance-tagline">Shoot to Kill</p>
  </div> -->
  
  <h1>Today's Alliance Train Riders</h1>
  <div id="dateDisplay"></div>
  <div id="countdown"></div>
  
  <div class="top-buttons">
    <button id="screenshotBtn">üì∏ Save Screenshot</button>
    <button id="historyBtn">üìú Show History</button>
    <button id="memberBtn" class="admin-button">üîê Manage Members</button>
  </div>
  
  <div class="train" id="train"></div>
  
  <div id="historyLog">
    <h3>Rotation History</h3>
    <div id="historyTools">
      <button id="exportBtn">üìÅ Export History</button>
      <button id="viewStatsBtn">üìä View Stats</button>
      <input type="text" id="filterInput" placeholder="Filter by player name...">
      <select id="sortOrder">
        <option value="asc">Sort by Oldest</option>
        <option value="desc">Sort by Newest</option>
      </select>
    </div>
    <div id="statsPanel" class="stats" style="display: none;">
      <h3>Statistics</h3>
      <div id="statsContent"></div>
    </div>
    <pre id="historyContent"></pre>
    <div class="pagination-controls">
      <div class="pagination">
        <button id="prevPage" disabled>‚óÄ Previous</button>
        <div class="pagination-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
        <button id="nextPage" disabled>Next ‚ñ∂</button>
      </div>
      <div class="page-size-control">
        <label for="pageSize">Entries per page:</label>
        <select id="pageSize">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="50">50</option>
          <option value="-1">Show All</option>
        </select>
      </div>
    </div>
  </div>
  
  <div id="memberPanel">
    <h3>Manage Alliance Members</h3>
    <div id="memberTools">
      <button id="refreshTrainBtn">üîÑ Refresh Train</button>
      <button id="backupMembersBtn">üíæ Backup Members</button>
      <button id="settingsBtn">‚öôÔ∏è Admin Settings</button>
    </div>
    
    <div id="settingsPanel" class="settings-section" style="display: none;">
      <h4>Admin Settings</h4>
      <div class="settings-row">
        <div class="settings-label">Change Admin Password:</div>
        <input type="password" id="newPassword" placeholder="New password">
        <button id="changePasswordBtn">Update</button>
      </div>
      <div class="settings-row">
        <div class="settings-label">Session Timeout:</div>
        <select id="sessionTimeout">
          <option value="5">5 minutes</option>
          <option value="10">10 minutes</option>
          <option value="15" selected>15 minutes</option>
          <option value="30">30 minutes</option>
          <option value="60">1 hour</option>
          <option value="240">4 hours</option>
          <option value="720">12 hours</option>
          <option value="1440">24 hours</option>
        </select>
      </div>
    </div>
    
    <div class="add-member-form">
      <input type="text" id="newMemberName" placeholder="Enter new member name...">
      <div class="role-options">
        <label class="role-option">
          <input type="radio" name="newMemberRole" value="regular" checked>
          Regular Member
        </label>
        <label class="role-option">
          <input type="radio" name="newMemberRole" value="r4r5">
          R4/R5 Member
        </label>
        <label class="role-option">
          <input type="radio" name="newMemberRole" value="leader">
          Leader
        </label>
      </div>
      <button id="addMemberBtn">+ Add Member</button>
    </div>
    
    <h4>Current Members</h4>
    <div class="member-list" id="memberList">
      <!-- Member items will be added here dynamically -->
    </div>
    
    <div class="import-export-area">
      <h4>Import/Export Members</h4>
      <textarea id="membersImportExport" placeholder="Copy member list here to import, or click Export Members to copy the current list..."></textarea>
      <div>
        <button id="exportMembersBtn">‚¨áÔ∏è Export Members</button>
        <button id="importMembersBtn">‚¨ÜÔ∏è Import Members</button>
      </div>
      <p class="reset-notice">Note: Changing members will reset today's train assignment. Previous history will be kept.</p>
    </div>
  </div>
  
  <!-- Password Dialog -->
  <div id="passwordDialog" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="modal-title">Admin Access Required</h3>
      <div class="modal-form">
        <p>Please enter the admin password to access member management:</p>
        <input type="password" id="adminPassword" placeholder="Enter password">
        <div id="passwordError" style="color: #ff6666; margin-top: 5px; display: none;">
          Incorrect password. Please try again.
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelPasswordBtn">Cancel</button>
        <button id="submitPasswordBtn">Submit</button>
      </div>
    </div>
  </div>
  
  <div class="footer">
    <p>SHOO Alliance Train Tracker &copy; 2025</p>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    // Keys for localStorage
    const historyKey = "trainHistory";
    const playerWagonHistoryKey = "playerWagonHistory";
    const lastAssignmentKey = "lastTrainAssignment";
    const membersKey = "trainMembers";
    const r4r5Key = "trainR4R5";
    const leadersKey = "trainLeaders";
    const adminPasswordKey = "trainAdminPassword";
    const adminSessionKey = "trainAdminSession";
    const adminSettingsKey = "trainAdminSettings";
    
    // Default members if none are stored
    const defaultMembers = ["Gstar79", "Venduro", "anonymous86", "eowynna", "MamaBear861","mamabear junior", "Frank", "George", "Helen", "Ivan", "Julia", "Kevin", "Laura", "Mike", "Nina", "Oscar", "Patty", "Quincy", "Rita", "Steve", "Tina", "Uma", "Victor", "Wendy", "Xander", "Yara", "Zack", "Liam", "Noah", "Olivia", "Emma"];
    const defaultR4R5 = ["Gstar79", "Venduro", "anonymous86", "eowynna"];
    const defaultLeaders = ["MamaBear861"];
    
    // Default admin settings
    const defaultAdminSettings = {
      sessionTimeout: 15 // minutes
    };
    
    // Load admin settings or use defaults
    let adminSettings = JSON.parse(localStorage.getItem(adminSettingsKey) || JSON.stringify(defaultAdminSettings));
    
    // If no admin password is set, set a default one
    if (!localStorage.getItem(adminPasswordKey)) {
      localStorage.setItem(adminPasswordKey, "admin123"); // Default password
    }
    
    // Load members from localStorage or use defaults
    let members = JSON.parse(localStorage.getItem(membersKey) || JSON.stringify(defaultMembers));
    let r4r5Members = JSON.parse(localStorage.getItem(r4r5Key) || JSON.stringify(defaultR4R5));
    let leaders = JSON.parse(localStorage.getItem(leadersKey) || JSON.stringify(defaultLeaders));
    
    // For backward compatibility - migrate from old VIPs to new roles
    const oldVipsKey = "trainVips";
    if (localStorage.getItem(oldVipsKey) && !localStorage.getItem(r4r5Key)) {
      const oldVips = JSON.parse(localStorage.getItem(oldVipsKey));
      // Set non-leader VIPs as R4/R5
      r4r5Members = oldVips.filter(vip => !leaders.includes(vip));
      localStorage.setItem(r4r5Key, JSON.stringify(r4r5Members));
    }
    
    // Save members to localStorage
    function saveMembers() {
      localStorage.setItem(membersKey, JSON.stringify(members));
      localStorage.setItem(r4r5Key, JSON.stringify(r4r5Members));
      localStorage.setItem(leadersKey, JSON.stringify(leaders));
    }
    
    // Check if a member has special role
    function getMemberRole(member) {
      if (leaders.includes(member)) return 'leader';
      if (r4r5Members.includes(member)) return 'r4r5';
      return 'regular';
    }
    
    // Update a member's role
    function updateMemberRole(member, newRole) {
      // Remove from all roles first
      r4r5Members = r4r5Members.filter(m => m !== member);
      leaders = leaders.filter(m => m !== member);
      
      // Add to new role if needed
      if (newRole === 'r4r5') {
        r4r5Members.push(member);
      } else if (newRole === 'leader') {
        leaders.push(member);
      }
      
      saveMembers();
    }
    
    // Admin authentication functions
    function isAdminAuthenticated() {
      const session = localStorage.getItem(adminSessionKey);
      if (!session) return false;
      
      try {
        const sessionData = JSON.parse(session);
        const expiryTime = new Date(sessionData.expiry);
        return expiryTime > new Date();
      } catch (e) {
        return false;
      }
    }
    
    function authenticateAdmin() {
      const expiryTime = new Date();
      expiryTime.setMinutes(expiryTime.getMinutes() + adminSettings.sessionTimeout);
      
      const sessionData = {
        expiry: expiryTime.toISOString()
      };
      
      localStorage.setItem(adminSessionKey, JSON.stringify(sessionData));
    }
    
    function logoutAdmin() {
      localStorage.removeItem(adminSessionKey);
    }
    
    // Show password dialog
    function showPasswordDialog(callback) {
      const dialog = document.getElementById('passwordDialog');
      const passwordInput = document.getElementById('adminPassword');
      const errorMsg = document.getElementById('passwordError');
      
      // Clear previous input and error
      passwordInput.value = '';
      errorMsg.style.display = 'none';
      
      // Show dialog
      dialog.classList.remove('hidden');
      passwordInput.focus();
      
      // Handle submit button
      const submitBtn = document.getElementById('submitPasswordBtn');
      const submitHandler = function() {
        const enteredPassword = passwordInput.value;
        const storedPassword = localStorage.getItem(adminPasswordKey);
        
        if (enteredPassword === storedPassword) {
          // Password correct
          authenticateAdmin();
          dialog.classList.add('hidden');
          submitBtn.removeEventListener('click', submitHandler);
          passwordInput.removeEventListener('keydown', keyHandler);
          if (callback) callback(true);
        } else {
          // Password incorrect
          errorMsg.style.display = 'block';
          passwordInput.value = '';
          passwordInput.focus();
        }
      };
      
      submitBtn.addEventListener('click', submitHandler);
      
      // Handle cancel button
      const cancelBtn = document.getElementById('cancelPasswordBtn');
      cancelBtn.addEventListener('click', function cancelHandler() {
        dialog.classList.add('hidden');
        submitBtn.removeEventListener('click', submitHandler);
        passwordInput.removeEventListener('keydown', keyHandler);
        cancelBtn.removeEventListener('click', cancelHandler);
        if (callback) callback(false);
      }, { once: true });
      
      // Handle Enter key in password field
      const keyHandler = function(e) {
        if (e.key === 'Enter') {
          submitHandler();
        }
      };
      
      passwordInput.addEventListener('keydown', keyHandler);
    }
    
    const today = new Date();
    const serverOffset = -8;
    const serverNow = new Date(today.getTime() + serverOffset * 60 * 60 * 1000);
    const dateString = serverNow.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById("dateDisplay").textContent = `Server Date: ${dateString}`;
    const seed = serverNow.toISOString().split('T')[0].split("-").join("");
    
    // Pagination variables
    let currentPage = 1;
    let pageSize = 10;
    let filteredHistory = [];
    
    // Load or initialize player history
    let playerWagonHistory = JSON.parse(localStorage.getItem(playerWagonHistoryKey) || "{}");
    
    // Initialize player history for new players
    function initializePlayerHistory() {
      members.forEach(member => {
        if (!playerWagonHistory[member]) {
          playerWagonHistory[member] = {
            wagonCounts: [0, 0, 0, 0], // Count of times in wagon 1, 2, 3, 4
            lastWagon: null,           // Last wagon they were assigned to
            priority: 0                // Priority score for fairer assignment
          };
        }
      });
      
      // Save updated player history
      localStorage.setItem(playerWagonHistoryKey, JSON.stringify(playerWagonHistory));
    }
    
    // Initialize player history
    initializePlayerHistory();

    function seededShuffle(arr, seed) {
      const out = [...arr];
      let random = mulberry32(parseInt(seed));
      for (let i = out.length - 1; i > 0; i--) {
        const j = Math.floor(random() * (i + 1));
        [out[i], out[j]] = [out[j], out[i]];
      }
      return out;
    }

    function mulberry32(a) {
      return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }
    
    // Generate train assignment for the day
    function generateTrainAssignment() {
      // Check if we already created today's assignment
      const lastAssignment = JSON.parse(localStorage.getItem(lastAssignmentKey) || "{}");
      let wagons = [];
      
      if (lastAssignment.date === seed && lastAssignment.memberCount === members.length) {
        // Use the saved assignment for today (only if member count hasn't changed)
        wagons = lastAssignment.wagons;
      } else {
        // Create a new fair assignment for today
        // First, shuffle members using seed for initial randomness
        const shuffled = seededShuffle(members, seed);
        
        // Then, calculate priority scores for each member
        shuffled.forEach(member => {
          const history = playerWagonHistory[member];
          if (history) {
            // Higher priority for players who haven't been in wagon 1 much
            // Lower priority for players who have been in wagon 1 a lot
            const wagonWeights = [4, 3, 2, 1]; // Weights for wagons 1-4
            
            // Calculate weighted score based on past assignments
            let weightedScore = 0;
            for (let i = 0; i < 4; i++) {
              weightedScore += history.wagonCounts[i] * wagonWeights[i];
            }
            
            // Adjust priority: lower score means higher priority for better wagons
            history.priority = -weightedScore;
            
            // Add bonus priority to avoid same wagon twice in a row
            if (history.lastWagon !== null) {
              // Add penalty if they were in a good wagon last time
              history.priority -= (4 - history.lastWagon) * 2;
            }
          }
        });
        
        // Sort by priority (higher priority first)
        const prioritized = [...shuffled].sort((a, b) => {
          // Higher priority scores first
          const priorityDiff = (playerWagonHistory[b]?.priority || 0) - (playerWagonHistory[a]?.priority || 0);
          if (priorityDiff !== 0) return priorityDiff;
          
          // If priority is same, leaders get highest preference, then R4/R5
          const aRole = getMemberRole(a);
          const bRole = getMemberRole(b);
          
          if (aRole === 'leader' && bRole !== 'leader') return -1;
          if (aRole !== 'leader' && bRole === 'leader') return 1;
          if (aRole === 'r4r5' && bRole !== 'r4r5') return -1;
          if (aRole !== 'r4r5' && bRole === 'r4r5') return 1;
          
          // Finally, use the seeded random as tiebreaker
          return 0.5 - mulberry32(parseInt(seed) + a.charCodeAt(0) + b.charCodeAt(0))();
        });
        
        // Take top 20 players after prioritization (or fewer if member count is less)
        const playerCount = Math.min(20, members.length);
        const selected = prioritized.slice(0, playerCount);
        
        // Initialize wagons
        wagons = [[], [], [], []];
        
        // Determine players per wagon
        const basePlayersPerWagon = Math.floor(playerCount / 4);
        const extraPlayers = playerCount % 4;
        
        // Calculate how many players should be in each wagon
        const playersPerWagon = [
          basePlayersPerWagon + (extraPlayers > 0 ? 1 : 0),
          basePlayersPerWagon + (extraPlayers > 1 ? 1 : 0),
          basePlayersPerWagon + (extraPlayers > 2 ? 1 : 0),
          basePlayersPerWagon
        ];
        
        // Assign players to wagons based on priority and calculated distribution
        let currentIndex = 0;
        for (let wagonIndex = 0; wagonIndex < 4; wagonIndex++) {
          for (let i = 0; i < playersPerWagon[wagonIndex]; i++) {
            const player = selected[currentIndex];
            wagons[wagonIndex].push(player);
            
            // Update player history
            const history = playerWagonHistory[player];
            if (history) {
              history.wagonCounts[wagonIndex]++;
              history.lastWagon = wagonIndex;
            }
            
            currentIndex++;
          }
        }
        
        // Save this assignment
        lastAssignment.date = seed;
        lastAssignment.wagons = wagons;
        lastAssignment.memberCount = members.length;
        localStorage.setItem(lastAssignmentKey, JSON.stringify(lastAssignment));
        
        // Save updated player history
        localStorage.setItem(playerWagonHistoryKey, JSON.stringify(playerWagonHistory));
        
        // Save in history
        const historyData = JSON.parse(localStorage.getItem(historyKey) || "{}");
        historyData[seed] = wagons;
        localStorage.setItem(historyKey, JSON.stringify(historyData));
      }
      
      return wagons;
    }
    
    // Display wagons on the page
    function displayTrain(wagons) {
      const trainEl = document.getElementById("train");
      trainEl.innerHTML = ""; // Clear previous wagons
      
      wagons.forEach((wagonMembers, index) => {
        const wagon = document.createElement("div");
        wagon.className = "wagon";
        
        // Add fairness indicators to show balanced rotation
        const wagonHTML = `<h2>Wagon ${index + 1}</h2><ul>${wagonMembers.map(m => {
          const history = playerWagonHistory[m];
          const totalRides = history ? history.wagonCounts.reduce((a, b) => a + b, 0) : 0;
          const fairnessIndicator = totalRides > 1 ? `<span class="fairness-indicator" title="Balanced rotation: has been in ${totalRides} different wagons">‚öñÔ∏è</span>` : '';
          const role = getMemberRole(m);
          const roleClass = role !== 'regular' ? role : '';
          return `<li class="${roleClass}">${m}${fairnessIndicator}</li>`;
        }).join('')}</ul>`;
        
        wagon.innerHTML = wagonHTML;
        trainEl.appendChild(wagon);
      });
    }

    // Generate and display today's train
    let currentWagons = generateTrainAssignment();
    displayTrain(currentWagons);

    // Process history data for pagination
    function processHistoryData(data, filter = '', order = 'asc') {
      const entries = Object.entries(data).sort(([a], [b]) => order === 'asc' ? a.localeCompare(b) : b.localeCompare(a));
      
      // Create an array of history entries for pagination
      return entries.map(([d, wagons]) => {
        const year = d.substring(0, 4);
        const month = d.substring(4, 6);
        const day = d.substring(6, 8);
        const readableDate = new Date(`${year}-${month}-${day}`).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        
        // For each date, create an object with the date and wagon info
        return {
          date: readableDate,
          wagons: wagons.map((w, i) => `  Wagon ${i + 1}: ${w.join(", ")}`),
          containsFilter: filter ? wagons.some(w => w.join(" ").toLowerCase().includes(filter.toLowerCase())) : true
        };
      }).filter(entry => entry.containsFilter);
    }

    // Format history data for display based on current page
    function formatPaginatedHistory(historyItems) {
      if (historyItems.length === 0) {
        return "No history data found.";
      }
      
      // Determine which items to show based on pagination
      let displayItems;
      if (pageSize === -1) {
        // Show all items
        displayItems = historyItems;
      } else {
        // Show paginated items
        const startIndex = (currentPage - 1) * pageSize;
        displayItems = historyItems.slice(startIndex, startIndex + pageSize);
      }
      
      // Format the items for display
      return displayItems.map(entry => {
        const wagonInfo = entry.wagons.filter(line => true); // Apply any additional filtering here if needed
        return `\n${entry.date}:\n` + wagonInfo.join("\n");
      }).join("\n---------------------------\n");
    }

    // Update pagination controls
    function updatePaginationControls() {
      const totalItems = filteredHistory.length;
      const totalPageCount = pageSize === -1 ? 1 : Math.ceil(totalItems / pageSize);
      
      // Update page numbers
      document.getElementById("currentPage").textContent = currentPage;
      document.getElementById("totalPages").textContent = totalPageCount;
      
      // Enable/disable prev/next buttons
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPageCount;
    }

    // Update history display with pagination
    function updateHistoryDisplay() {
      const content = document.getElementById("historyContent");
      const saved = JSON.parse(localStorage.getItem(historyKey) || "{}");
      const filter = document.getElementById("filterInput").value;
      const order = document.getElementById("sortOrder").value;
      
      // Process history data
      filteredHistory = processHistoryData(saved, filter, order);
      
      // Ensure current page is valid
      const totalPageCount = pageSize === -1 ? 1 : Math.ceil(filteredHistory.length / pageSize);
      if (currentPage > totalPageCount && totalPageCount > 0) {
        currentPage = totalPageCount;
      } else if (currentPage < 1 || totalPageCount === 0) {
        currentPage = 1;
      }
      
      // Format and display current page
      content.textContent = formatPaginatedHistory(filteredHistory);
      
      // Update pagination controls
      updatePaginationControls();
    }

    function generateFairnessStats() {
      // Analyze fairness stats
      const stats = {
        totalRides: {},
        wagonDistribution: {}
      };
      
      // Count total rides and wagon distribution for each player
      members.forEach(member => {
        const history = playerWagonHistory[member];
        if (history) {
          stats.totalRides[member] = history.wagonCounts.reduce((a, b) => a + b, 0);
          stats.wagonDistribution[member] = [...history.wagonCounts];
        }
      });
      
      // Generate HTML for stats
      let html = '<table>';
      html += '<tr><th style="text-align:left;">Player</th>';
      html += '<th style="text-align:center;">Total</th>';
      html += '<th style="text-align:center;">W1</th>';
      html += '<th style="text-align:center;">W2</th>';
      html += '<th style="text-align:center;">W3</th>';
      html += '<th style="text-align:center;">W4</th></tr>';
      
      // Only show players who have been on the train
      const activePlayers = members.filter(m => stats.totalRides[m] > 0)
        .sort((a, b) => stats.totalRides[b] - stats.totalRides[a]);
      
      activePlayers.forEach(player => {
        const role = getMemberRole(player);
        const distro = stats.wagonDistribution[player] || [0,0,0,0];
        
        // Set color based on role
        let styleColor = '';
        if (role === 'r4r5') styleColor = 'color:gold; font-weight:bold;';
        else if (role === 'leader') styleColor = 'color:#cc44ff; font-weight:bold;';
        
        html += `<tr>
          <td style="text-align:left; ${styleColor}">${player}</td>
          <td style="text-align:center;">${stats.totalRides[player]}</td>
          <td style="text-align:center;">${distro[0]}</td>
          <td style="text-align:center;">${distro[1]}</td>
          <td style="text-align:center;">${distro[2]}</td>
          <td style="text-align:center;">${distro[3]}</td>
        </tr>`;
      });
      
      html += '</table>';
      
      // Add a small explanation about the fairness system
      html += '<p style="font-size:0.8rem; margin-top:15px; color:#aaa;">The system ensures players rotate through different wagons over time. Wagon 1 has the best rewards, followed by 2, 3, and 4. Players who haven\'t been in better wagons get higher priority.</p>';
      
      return html;
    }
    
    // Render the member list
    function renderMemberList() {
      const memberListEl = document.getElementById("memberList");
      memberListEl.innerHTML = ""; // Clear the list
      
      // Sort members - Leaders first, then R4/R5, then regular members, all alphabetically within groups
      const sortedMembers = [...members].sort((a, b) => {
        const aRole = getMemberRole(a);
        const bRole = getMemberRole(b);
        
        // Leaders come first
        if (aRole === 'leader' && bRole !== 'leader') return -1;
        if (aRole !== 'leader' && bRole === 'leader') return 1;
        
        // Then R4/R5
        if (aRole === 'r4r5' && bRole !== 'r4r5') return -1;
        if (aRole !== 'r4r5' && bRole === 'r4r5') return 1;
        
        // Alphabetically within groups
        return a.localeCompare(b);
      });
      
      // Add each member to the list
      sortedMembers.forEach(member => {
        const role = getMemberRole(member);
        const memberItem = document.createElement("div");
        memberItem.className = `member-item ${role !== 'regular' ? role : ''}`;
        
        // Create role tag based on member role
        let roleTag = '';
        let roleToggleContent = '';
        
        if (role === 'leader') {
          roleTag = '<span class="role-tag leader-tag">Leader</span>';
          roleToggleContent = 'üëë';
        } else if (role === 'r4r5') {
          roleTag = '<span class="role-tag r4r5-tag">R4/R5</span>';
          roleToggleContent = '‚≠ê';
        } else {
          roleToggleContent = '‚òÜ';
        }
        
        memberItem.innerHTML = `
          ${role !== 'regular' ? roleTag : ''}
          <span>${member}</span>
          <span class="member-role-toggle ${role !== 'regular' ? `role-${role}` : ''}" title="Change role">${roleToggleContent}</span>
          <span class="member-delete" title="Remove member">‚úï</span>
        `;
        
        // Add event listener for deleting member
        memberItem.querySelector(".member-delete").addEventListener("click", () => {
          if (members.length <= 4) {
            alert("You need at least 4 members for the train system to work properly.");
            return;
          }
          
          if (confirm(`Are you sure you want to remove ${member} from the alliance?`)) {
            members = members.filter(m => m !== member);
            r4r5Members = r4r5Members.filter(m => m !== member);
            leaders = leaders.filter(m => m !== member);
            saveMembers();
            renderMemberList();
          }
        });
        
        // Add event listener for cycling through roles
        memberItem.querySelector(".member-role-toggle").addEventListener("click", () => {
          // Cycle through roles: regular -> r4r5 -> leader -> regular
          if (role === 'regular') {
            updateMemberRole(member, 'r4r5');
          } else if (role === 'r4r5') {
            updateMemberRole(member, 'leader');
          } else if (role === 'leader') {
            updateMemberRole(member, 'regular');
          }
          
          renderMemberList();
        });
        
        memberListEl.appendChild(memberItem);
      });
    }

    // Track panel visibility states
    let historyVisible = false;
    let memberPanelVisible = false;
    
    document.getElementById("historyBtn").addEventListener("click", function() {
      const log = document.getElementById("historyLog");
      const historyBtn = document.getElementById("historyBtn");
      
      // If member panel is visible, hide it first
      if (memberPanelVisible) {
        document.getElementById("memberPanel").style.display = "none";
        document.getElementById("memberBtn").textContent = "üîê Manage Members";
        memberPanelVisible = false;
      }
      
      // Toggle the history visibility state
      historyVisible = !historyVisible;
      
      // Apply the visibility
      log.style.display = historyVisible ? "block" : "none";
      
      // Update button text
      historyBtn.textContent = historyVisible ? "üìú Hide History" : "üìú Show History";
      
      // Only load content and scroll if we're showing the history
      if (historyVisible) {
        updateHistoryDisplay();
        
        // Scroll to history section
        log.scrollIntoView({ behavior: "smooth" });
      }
    });
    
    document.getElementById("memberBtn").addEventListener("click", function() {
      // If already authenticated, show the panel directly
      if (isAdminAuthenticated()) {
        toggleMemberPanel();
      } else {
        // Otherwise, show password dialog
        showPasswordDialog(function(success) {
          if (success) {
            toggleMemberPanel();
          }
        });
      }
    });
    
    function toggleMemberPanel() {
      const panel = document.getElementById("memberPanel");
      const memberBtn = document.getElementById("memberBtn");
      
      // Toggle the member panel visibility state
      memberPanelVisible = !memberPanelVisible;
      
      // Apply the visibility
      panel.style.display = memberPanelVisible ? "block" : "none";
      
      // Update button text
      memberBtn.textContent = memberPanelVisible ? "üë• Hide Members" : "üîê Manage Members";
      
      // If showing panel, hide history (if visible) and render members
      if (memberPanelVisible) {
        // If history is visible, hide it first
        if (historyVisible) {
          document.getElementById("historyLog").style.display = "none";
          document.getElementById("historyBtn").textContent = "üìú Show History";
          historyVisible = false;
        }
        
        // Render members and scroll to panel
        renderMemberList();
        panel.scrollIntoView({ behavior: "smooth" });
        
        // Update settings display
        document.getElementById("sessionTimeout").value = adminSettings.sessionTimeout;
      }
    }

    document.getElementById("viewStatsBtn").addEventListener("click", () => {
      const statsPanel = document.getElementById("statsPanel");
      const statsContent = document.getElementById("statsContent");
      
      // Toggle stats panel
      if (statsPanel.style.display === "none") {
        statsContent.innerHTML = generateFairnessStats();
        statsPanel.style.display = "block";
      } else {
        statsPanel.style.display = "none";
      }
    });
    
    // Settings panel
    document.getElementById("settingsBtn").addEventListener("click", function() {
      const settingsPanel = document.getElementById("settingsPanel");
      settingsPanel.style.display = settingsPanel.style.display === "none" ? "block" : "none";
    });
    
    document.getElementById("changePasswordBtn").addEventListener("click", function() {
      const newPassword = document.getElementById("newPassword").value.trim();
      
      if (!newPassword) {
        alert("Please enter a new password.");
        return;
      }
      
      localStorage.setItem(adminPasswordKey, newPassword);
      document.getElementById("newPassword").value = "";
      alert("Admin password updated successfully!");
    });
    
    document.getElementById("sessionTimeout").addEventListener("change", function() {
      adminSettings.sessionTimeout = parseInt(this.value);
      localStorage.setItem(adminSettingsKey, JSON.stringify(adminSettings));
    });

    // Pagination event listeners
    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        updateHistoryDisplay();
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      const totalPageCount = pageSize === -1 ? 1 : Math.ceil(filteredHistory.length / pageSize);
      if (currentPage < totalPageCount) {
        currentPage++;
        updateHistoryDisplay();
      }
    });

    document.getElementById("pageSize").addEventListener("change", function() {
      pageSize = parseInt(this.value);
      currentPage = 1; // Reset to first page when changing page size
      updateHistoryDisplay();
    });

    document.getElementById("filterInput").addEventListener("input", () => {
      currentPage = 1; // Reset to first page when filtering
      updateHistoryDisplay();
    });

    document.getElementById("sortOrder").addEventListener("change", updateHistoryDisplay);

    document.getElementById("exportBtn").addEventListener("click", () => {
      const saved = JSON.parse(localStorage.getItem(historyKey) || "{}");
      // Format all history for export (no pagination)
      const allHistory = processHistoryData(saved);
      const content = formatPaginatedHistory(allHistory);
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement("a");
      link.download = `SHOO-train-history.txt`;
      link.href = URL.createObjectURL(blob);
      link.click();
    });
    
    // Member management functions
    document.getElementById("addMemberBtn").addEventListener("click", () => {
      const nameInput = document.getElementById("newMemberName");
      const roleInputs = document.getElementsByName("newMemberRole");
      
      const memberName = nameInput.value.trim();
      
      if (!memberName) {
        alert("Please enter a member name.");
        return;
      }
      
      if (members.includes(memberName)) {
        alert("This member already exists in the list.");
        return;
      }
      
      // Find selected role
      let selectedRole = 'regular';
      for (const input of roleInputs) {
        if (input.checked) {
          selectedRole = input.value;
          break;
        }
      }
      
      // Add the new member
      members.push(memberName);
      
      // Add to role lists if needed
      if (selectedRole === 'r4r5') {
        r4r5Members.push(memberName);
      } else if (selectedRole === 'leader') {
        leaders.push(memberName);
      }
      
      // Initialize player history for the new member
      playerWagonHistory[memberName] = {
        wagonCounts: [0, 0, 0, 0],
        lastWagon: null,
        priority: 0
      };
      
      // Save the updated lists
      saveMembers();
      localStorage.setItem(playerWagonHistoryKey, JSON.stringify(playerWagonHistory));
      
      // Clear the input fields
      nameInput.value = "";
      roleInputs[0].checked = true; // Reset to "Regular Member"
      
      // Re-render the member list
      renderMemberList();
    });
    
    document.getElementById("refreshTrainBtn").addEventListener("click", () => {
      if (confirm("Are you sure you want to regenerate today's train assignment? This will create a new distribution based on the current member list.")) {
        // Remove today's assignment so it will be regenerated
        localStorage.removeItem(lastAssignmentKey);
        
        // Generate and display new assignment
        currentWagons = generateTrainAssignment();
        displayTrain(currentWagons);
        
        alert("Train assignment has been refreshed!");
      }
    });
    
    document.getElementById("backupMembersBtn").addEventListener("click", () => {
      localStorage.setItem("trainMembersBackup", JSON.stringify(members));
      localStorage.setItem("trainR4R5Backup", JSON.stringify(r4r5Members));
      localStorage.setItem("trainLeadersBackup", JSON.stringify(leaders));
      alert("Member list backed up! You can restore this backup if needed.");
    });
    
    document.getElementById("exportMembersBtn").addEventListener("click", () => {
      const textarea = document.getElementById("membersImportExport");
      const exportData = {
        members: members,
        r4r5: r4r5Members,
        leaders: leaders
      };
      textarea.value = JSON.stringify(exportData, null, 2);
      textarea.select();
      document.execCommand("copy");
      alert("Member list copied to clipboard and displayed in the text area. You can save this for backup.");
    });
    
    document.getElementById("importMembersBtn").addEventListener("click", () => {
      const textarea = document.getElementById("membersImportExport");
      const importText = textarea.value.trim();
      
      if (!importText) {
        alert("Please paste a member list in the text area before importing.");
        return;
      }
      
      try {
        const importData = JSON.parse(importText);
        
        if (!importData.members || !Array.isArray(importData.members) || importData.members.length < 4) {
          throw new Error("Invalid member list format or not enough members (minimum 4).");
        }
        
        if (confirm("Are you sure you want to replace the current member list? This will reset today's train assignment.")) {
          // Backup current list first
          localStorage.setItem("trainMembersBackup", JSON.stringify(members));
          localStorage.setItem("trainR4R5Backup", JSON.stringify(r4r5Members));
          localStorage.setItem("trainLeadersBackup", JSON.stringify(leaders));
          
          // Update members
          members = importData.members;
          
          // Update roles (with backward compatibility for old format)
          if (Array.isArray(importData.r4r5)) {
            r4r5Members = importData.r4r5.filter(m => members.includes(m));
          } else if (Array.isArray(importData.vips)) {
            // Handle old format with VIPs
            const oldVips = importData.vips.filter(m => members.includes(m));
            r4r5Members = oldVips.filter(v => !importData.leaders || !importData.leaders.includes(v));
          } else {
            r4r5Members = [];
          }
          
          if (Array.isArray(importData.leaders)) {
            leaders = importData.leaders.filter(m => members.includes(m));
          } else {
            leaders = [];
          }
          
          // Save the updated lists
          saveMembers();
          
          // Initialize history for new members
          initializePlayerHistory();
          
          // Reset today's assignment
          localStorage.removeItem(lastAssignmentKey);
          
          // Generate and display new assignment
          currentWagons = generateTrainAssignment();
          displayTrain(currentWagons);
          
          // Re-render the member list
          renderMemberList();
          
          alert("Member list imported successfully!");
        }
      } catch (error) {
        alert("Error importing member list: " + error.message);
      }
    });

    function updateCountdown() {
      const now = new Date();
      const nextMidnight = new Date(Date.UTC(serverNow.getUTCFullYear(), serverNow.getUTCMonth(), serverNow.getUTCDate() + 1));
      const diff = nextMidnight - (new Date(now.getTime() + serverOffset * 60 * 60 * 1000));
      const hrs = Math.floor(diff / 3600000);
      const mins = Math.floor((diff % 3600000) / 60000);
      const secs = Math.floor((diff % 60000) / 1000);
      document.getElementById("countdown").textContent = `Next train in: ${hrs}h ${mins}m ${secs}s (Server Time)`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    document.getElementById("screenshotBtn").addEventListener("click", () => {
      html2canvas(document.body).then(canvas => {
        const link = document.createElement("a");
        link.download = `SHOO-train-roster-${seed}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    });
  </script>
</body>
</html>